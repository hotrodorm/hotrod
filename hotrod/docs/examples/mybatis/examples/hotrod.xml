<?xml version="1.0"?>
<!DOCTYPE hotrod SYSTEM "hotrod.dtd">

<hotrod>

  <generators>
    <mybatis>
      <daos gen-base-dir="auto-generated/java" dao-package="daos" />
      <mappers gen-base-dir="auto-generated/mappers"
        relative-dir="persistence" />
      <mybatis-configuration-template
        file="mybatis-template.xml" />
      <session-factory singleton-full-class-name="sessionfactory.DatabaseSessionFactory" />
      <select-generation temp-view-base-name="hotrod_temp_view" />
    </mybatis>
  </generators>

  <table name="branch">
    <auto-generated-column name="id"
      allows-specified-value="true" />
  </table>

  <table name="vehicle">
    <auto-generated-column name="id" />
  </table>

  <view name="car" />
  <view name="motorcycle" />
  <view name="truck" />

  <table name="client">
    <auto-generated-column name="id" sequence="client_seq" />
    <version-control-column name="row_version" />

    <sequence name="client_seq" />

    <query java-method-name="computeTotalPurchased">
    <![CDATA[
      update client c set total_purchased = (
        select sum(p.final_price) from purchase p where p.client_id = c.id
      )
    ]]>
    </query>

    <query java-method-name="upgradeToVIP">
    <![CDATA[
      update client c set vip = (
        select count(*) from purchase p where p.client_id = c.id
      ) > #{minPurchases,javaType=java.lang.Integer,jdbcType=NUMERIC}
    ]]>
    </query>

    <query java-method-name="deleteInactiveClients">
    <![CDATA[
      delete from client c 
        where (select count(*) from purchase p where p.client_id = c.id) = 0 
        and #{createdBefore,javaType=java.sql.Date,jdbcType=DATE} >= created_at  
        and (select count(*) from client rf where rf.referred_by_id = c.id) = 0
    ]]>
    </query>

  </table>

  <!-- Simple Select -->
  <select java-class-name="CreatedClient">
    <![CDATA[
      select * from client
        {* 
        where created_at between #{since,javaType=java.sql.Date,jdbcType=DATE}
                             and #{until,javaType=java.sql.Date,jdbcType=DATE}
        *}
    ]]>
  </select>

  <!-- Select returns fully-typed columns from multiple tables -->
  <select java-class-name="ClientWithPurchase">
    <![CDATA[
      select p.*, c.vip, c.state from purchase p
        join client c on (c.id) = (p.client_id)
        {*
        where p.purchase_date = #{purchaseDate,javaType=java.sql.Date,jdbcType=DATE}
        *}
    ]]>
  </select>

  <!-- Select grouping data -->
  <select java-class-name="DailyTotal">
    <![CDATA[
      select 
          purchase_date, count(*) as number_of_purchases, sum(vehicle_price) as price, 
          sum(extras_price) as extras, sum(discount) as discount, sum(tax) as taxes, sum(final_price) as revenue
        from purchase
        {*
        where purchase_date between #{from,javaType=java.sql.Date,jdbcType=DATE}
                                and #{to,javaType=java.sql.Date,jdbcType=DATE}
        group by purchase_date
        *}
    ]]>
  </select>

  <!-- Select using sub queries -->
  <select java-class-name="ClientNeverOfferedDiscount">
    <![CDATA[
      select * from client where id not in (select client_id from purchase where discount > 0)
    ]]>
  </select>

  <!-- Native SQL - Limiting rows at the DB level -->
  <select java-class-name="NonVIPClient">
    <![CDATA[
      select * from client
        {* 
        where vip = false
        limit #{maxRows,javaType=java.lang.Integer,jdbcType=NUMERIC}
        *}
    ]]>
  </select>

  <!-- Native SQL - Native Function -->
  <select java-class-name="VehiclePrice">
    <![CDATA[
      select id, ifnull(list_price, '0') as price from vehicle
        {*
        where brand = #{brandName,javaType=java.lang.String,jdbcType=VARCHAR}
        *}
    ]]>
  </select>

  <!-- Dynamic SQL - Searching by Combined Conditions -->
  <select java-class-name="SearchedClient">
    <![CDATA[
      select c.* from client c
        {*
        <where>
          <if test="#{minPurchases,javaType=java.lang.Integer,jdbcType=NUMERIC} != null">
            and (select count(*) from purchase p where p.client_id = c.id ) >= #{minPurchases}
          </if>
          <if test="#{state,javaType=java.lang.String,jdbcType=VARCHAR} != null">
            and c.state = #{state}
          </if>
          <if test="#{createdSince,javaType=java.sql.Date,jdbcType=DATE} != null">
            and created_at > #{createdSince}
          </if>
        </where>
        *}
    ]]>
  </select>

  <fragment file="hotrod-sales.xml" />

  <fragment file="hotrod-accounting.xml" />

</hotrod>
