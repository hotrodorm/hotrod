package org.hotrod.generator.mybatis;

import java.util.ArrayList;
import java.util.LinkedHashMap;
import java.util.List;

import org.apache.log4j.Logger;
import org.hotrod.ant.ControlledException;
import org.hotrod.ant.HotRodAntTask.DisplayMode;
import org.hotrod.ant.UncontrolledException;
import org.hotrod.config.CustomDAOTag;
import org.hotrod.config.HotRodConfigTag;
import org.hotrod.config.MyBatisTag;
import org.hotrod.config.SelectTag;
import org.hotrod.config.TableTag;
import org.hotrod.config.ViewTag;
import org.hotrod.generator.DAOType;
import org.hotrod.generator.HotRodGenerator;
import org.hotrod.metadata.AutoGeneratedColumnMetadata;
import org.hotrod.metadata.DataSetMetadata;
import org.hotrod.metadata.EnumDataSetMetadata;
import org.hotrod.metadata.SelectDataSetMetadata;
import org.hotrod.metadata.TableDataSetMetadata;
import org.nocrala.tools.database.tartarus.core.DatabaseLocation;

public class MyBatisGenerator extends HotRodGenerator {

  private static transient final Logger log = Logger.getLogger(MyBatisGenerator.class);

  private MyBatisTag myBatisTag;

  private LinkedHashMap<DataSetMetadata, ObjectAbstractVO> abstractVos = new LinkedHashMap<DataSetMetadata, ObjectAbstractVO>();
  private LinkedHashMap<DataSetMetadata, ObjectVO> vos = new LinkedHashMap<DataSetMetadata, ObjectVO>();
  private LinkedHashMap<DataSetMetadata, ObjectDAO> daos = new LinkedHashMap<DataSetMetadata, ObjectDAO>();
  private LinkedHashMap<DataSetMetadata, Mapper> mappers = new LinkedHashMap<DataSetMetadata, Mapper>();
  private LinkedHashMap<EnumDataSetMetadata, EnumClass> enumClasses = new LinkedHashMap<EnumDataSetMetadata, EnumClass>();
  private MyBatisConfiguration myBatisConfig;

  private List<CustomDAO> customDAOs = new ArrayList<CustomDAO>();
  private List<CustomDAOMapper> customMappers = new ArrayList<CustomDAOMapper>();

  public MyBatisGenerator(final DatabaseLocation loc, final HotRodConfigTag config, final DisplayMode displayMode)
      throws UncontrolledException, ControlledException {
    super(loc, config, displayMode);
  }

  @Override
  public void prepareGeneration() throws UncontrolledException, ControlledException {
    log.debug("prepare");

    // Load and validate the configuration file

    this.myBatisConfig = new MyBatisConfiguration(this.config);

    this.myBatisTag = (MyBatisTag) this.config.getGenerators().getSelectedGeneratorTag();

    // Add tables

    for (DataSetMetadata tm : this.tables) {
      log.debug("tm=" + tm.getIdentifier().getSQLIdentifier());
      addDaosAndMapper(tm, DAOType.TABLE);

      // Validate allows-specified-value
      AutoGeneratedColumnMetadata agcm = tm.getAutoGeneratedColumnMetadata();
      if (agcm != null) {
        if (agcm.isIdentity() && agcm.allowsSpecifiedValue()) {
          if (!this.adapter.supportsSpecifiedIdentityPKs()) {
            throw new ControlledException("Invalid 'allows-specified-values' attribute on table '"
                + tm.getIdentifier().getSQLIdentifier() + "'. HotRod does not support this feature on this database.");
          }
        }
      }
    }

    // Add views

    for (TableDataSetMetadata vm : this.views) {
      addDaosAndMapper(vm, DAOType.VIEW);
    }

    // Add enums

    for (EnumDataSetMetadata em : this.enums) {
      this.enumClasses.put(em, new EnumClass(em, new DataSetLayout(this.config), this.myBatisTag.getDaos(), this));
    }

    // Add selects

    for (SelectDataSetMetadata sm : this.selects) {
      addDaosAndMapper(sm);
    }

    // Add custom DAOs

    DataSetLayout layout = new DataSetLayout(this.config);

    for (CustomDAOTag tag : this.config.getDAOs()) {
      CustomDAO dao = new CustomDAO(tag, layout, this);
      CustomDAOMapper mapper = new CustomDAOMapper(tag, layout, this);
      dao.setMapper(mapper);
      mapper.setDao(dao);
      this.customDAOs.add(dao);
      this.customMappers.add(mapper);
    }

    // Prepare MyBatis Configuration File list

    for (CustomDAOTag tag : this.config.getAllDAOs()) {
      CustomDAOMapper mapper = new CustomDAOMapper(tag, layout, this);
      this.myBatisConfig.addMapperPrimitives(mapper);
    }

    for (Mapper mapper : this.mappers.values()) {
      String sourceFile = mapper.getRuntimeSourceFileName();
      this.myBatisConfig.addSourceFile(sourceFile);
    }

  }

  private void addDaosAndMapper(final DataSetMetadata metadata, final DAOType type) throws ControlledException {

    MyBatisTag myBatisTag = (MyBatisTag) this.config.getGenerators().getSelectedGeneratorTag();

    DataSetLayout layout;
    ObjectAbstractVO abstractVO;
    ObjectVO vo;
    Mapper mapper;
    ObjectDAO dao;

    switch (type) {

    case TABLE:
      TableTag ttag = this.config.findTable(metadata, this.adapter);
      if (ttag == null) {
        throw new ControlledException(
            "Could not find table tag for table '" + metadata.getIdentifier().getSQLIdentifier() + "'.");
      }
      layout = new DataSetLayout(this.config, ttag);

      abstractVO = new ObjectAbstractVO(metadata, layout, this, DAOType.TABLE, myBatisTag);
      vo = new ObjectVO(metadata, layout, this, abstractVO, myBatisTag);
      mapper = new Mapper(ttag, metadata, layout, this, type, this.adapter, vo);
      dao = new ObjectDAO(ttag, metadata, layout, this, type, myBatisTag, vo, mapper);
      mapper.setDao(dao);

      break;

    case VIEW:
      ViewTag vtag = this.config.findView(metadata, this.adapter);
      if (vtag == null) {
        throw new ControlledException(
            "Could not find view tag for table '" + metadata.getIdentifier().getSQLIdentifier() + "'.");
      }
      layout = new DataSetLayout(this.config);

      abstractVO = new ObjectAbstractVO(metadata, layout, this, DAOType.VIEW, myBatisTag);
      vo = new ObjectVO(metadata, layout, this, abstractVO, myBatisTag);
      mapper = new Mapper(vtag, metadata, layout, this, type, this.adapter, vo);
      dao = new ObjectDAO(vtag, metadata, layout, this, type, myBatisTag, vo, mapper);
      mapper.setDao(dao);

      break;

    default:
      throw new ControlledException(
          "Unrecognized type for database object '" + metadata.getIdentifier().getSQLIdentifier() + "'.");
    }

    this.abstractVos.put(metadata, abstractVO);
    this.vos.put(metadata, vo);
    this.mappers.put(metadata, mapper);
    this.daos.put(metadata, dao);

  }

  private void addDaosAndMapper(final SelectDataSetMetadata metadata) throws ControlledException {

    DataSetLayout layout;
    ObjectAbstractVO abstractVO;
    ObjectVO vo;
    Mapper mapper;
    ObjectDAO dao;

    SelectTag stag = this.config.findSelect(metadata, this.adapter);
    layout = new DataSetLayout(this.config);

    abstractVO = new ObjectAbstractVO(metadata, layout, this, DAOType.SELECT, myBatisTag);
    vo = new ObjectVO(metadata, layout, this, abstractVO, myBatisTag);
    mapper = new Mapper(stag, metadata, layout, this, DAOType.SELECT, this.adapter, vo);
    dao = new ObjectDAO(stag, metadata, layout, this, DAOType.SELECT, myBatisTag, vo, mapper);
    mapper.setDao(dao);

    this.abstractVos.put(metadata, abstractVO);
    this.vos.put(metadata, vo);
    this.mappers.put(metadata, mapper);
    this.daos.put(metadata, dao);

  }

  @Override
  public void generate() throws UncontrolledException, ControlledException {

    display("");
    display("Generating MyBatis DAOs & VOs...");

    // Abstract VOs, VOs, DAOs, and Mappers for <table> & <view> tags

    for (ObjectAbstractVO abstractVO : this.abstractVos.values()) {
      abstractVO.generate();
    }

    for (ObjectVO vo : this.vos.values()) {
      vo.generate();
    }

    for (ObjectDAO dao : this.daos.values()) {
      dao.generate();
    }

    for (Mapper mapper : this.mappers.values()) {
      mapper.generate();
    }

    // Enums

    for (EnumClass ec : this.enumClasses.values()) {
      ec.generate();
    }

    // Custom <dao> tags

    for (CustomDAO d : this.customDAOs) {
      d.generate();
    }

    for (CustomDAOMapper m : this.customMappers) {
      m.generate();
    }

    // MyBatis Main configuration file

    this.myBatisConfig.generate();

    // Generation complete

    display("");
    display("MyBatis generation complete.");
  }

  public ObjectVO getVO(final DataSetMetadata dataSet) {
    return this.vos.get(dataSet);
  }

  public ObjectDAO getDAO(final DataSetMetadata dataSet) {
    return this.daos.get(dataSet);
  }

  public EnumClass getEnum(final DataSetMetadata dataSet) {
    return this.enumClasses.get(dataSet);
  }

  public Mapper getMapper(final DataSetMetadata dataSet) {
    return this.mappers.get(dataSet);
  }

  // Helpers

}
